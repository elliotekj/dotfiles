# - Plugins ----------------------------------------------------------

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'

# Session persistence
set -g @continuum-restore 'on'
set -g @resurrect-capture-pane-contents 'on'
set -g @plugin 'omerxx/tmux-floax'
set -g @plugin 'sainnhe/tmux-fzf'
set -g @plugin 'elliotekj/tmux_drawer'
set -g @plugin 'ddzero2c/tmux-easymotion'

# automatically install tmux plugin on new machines,
# see https://github.com/tmux-plugins/tpm/blob/master/docs/automatic_tpm_installation.md.
if "test ! -d ~/.config/tmux/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm ~/.config/tmux/plugins/tpm && ~/.config/tmux/plugins/tpm/bin/install_plugins'"

set-option -g default-shell $SHELL

# - Appearance -------------------------------------------------------

set -g default-terminal "tmux-256color"
set -ag terminal-overrides ",xterm-256color:RGB"

set -g status on
set -g status-position top
set -g mouse on

# Status bar styling
set -g status-style 'bg=black,fg=white'
set -g status-left ''
set -g status-right '#{?window_zoomed_flag, [ZOOMED] ,}#[bg=brightblack,fg=white] #S '
set -g status-justify left

# Window status styling
set -g window-status-format ' #W '
set -g window-status-current-format ' #W '
set -g window-status-current-style 'bg=green,fg=black,bold'
set -g window-status-separator ''

# Pane dimming (inactive panes are dimmed)
set -g window-style 'fg=#939293,bg=#28252a'
set -g window-active-style 'fg=#fcfcfa,bg=#2d2a2e'

# Pane border styling
set -g pane-border-style 'fg=#403e41,bg=#28252a'
set -g pane-active-border-style 'fg=#403e41,bg=#28252a'

# - Mappings ---------------------------------------------------------

# easy motion
set -g @easymotion-key 'Space'

# better copy/paste
setw -g mode-keys vi
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "pbcopy"
bind P paste-buffer
bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe "pbcopy"

unbind-key s
bind s split-window -v -c "#{pane_current_path}"
bind v split-window -h -c "#{pane_current_path}"

# CMD+d for horizontal split (split right), CMD+Shift+d for vertical split (split down)
# Terminal sends these as escape sequences
bind-key -n C-y split-window -h -c "#{pane_current_path}"  # CMD+d -> Ctrl+y
bind-key -n C-q split-window -v -c "#{pane_current_path}"  # CMD+Shift+d -> Ctrl+q

# choose a session from the session list
bind S choose-session

# refresh config
bind-key R source-file ~/.config/tmux/tmux.conf

# window creation
# bind c display-popup -w 80% -h 80% -e SHELL=/bin/sh -E ~/bin/tmux_yazi_new_window.sh
bind c new-window -a

# skip "kill-pane 1? (y/n)" prompt
bind-key x kill-pane

# move current pane to its own window
bind b break-pane

# CMD+w to close pane (requires terminal configuration)
# Terminal sends Ctrl+W (hex code 0x17) for CMD+w
# Smart script checks if Helix is running and either:
#   - Sends C-w to Helix for window navigation, or
#   - Kills the pane if Helix is not running
bind-key -n C-w run-shell "~/bin/tmux_smart_close.sh"

# CMD+z to zoom pane (requires terminal configuration)
# Terminal sends Ctrl+\ (hex code 0x1c) for CMD+z
bind-key -n C-\\ resize-pane -Z

# exit tmux when closing the last pane in a session
set -g detach-on-destroy on

# move around windows
bind -n 'M-{' previous-window
bind -n 'M-}' next-window

# reorder windows (move tab left/right)
bind -n 'M-<' 'swap-window -t -1; select-window -t -1'
bind -n 'M->' 'swap-window -t +1; select-window -t +1'

# move around panes
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R
bind -n M-h select-pane -L
bind -n M-j select-pane -D
bind -n M-k select-pane -U
bind -n M-l select-pane -R

# CMD+Shift+h/j/k/l for pane navigation
# Terminal sends these as escape sequences
bind-key -n C-Left select-pane -L   # CMD+Shift+h -> Ctrl+Left
bind-key -n C-Down select-pane -D   # CMD+Shift+j -> Ctrl+Down
bind-key -n C-Up select-pane -U     # CMD+Shift+k -> Ctrl+Up
bind-key -n C-Right select-pane -R  # CMD+Shift+l -> Ctrl+Right

# resize panes
bind < resize-pane -L 10
bind > resize-pane -R 10
bind - resize-pane -D 10
bind + resize-pane -U 10

TMUX_FZF_LAUNCH_KEY="C-f"
TMUX_FZF_ORDER="session|window|pane|command|keybinding|clipboard|process"
bind -n C-k run-shell -b "~/.config/tmux/plugins/tmux-fzf/scripts/window.sh switch"
bind -n C-p run-shell -b "~/.config/tmux/plugins/tmux-fzf/scripts/session.sh switch"

bind-key t run-shell "~/.config/tmux/plugins/tmux_drawer/tmux_drawer.tmux toggle 50"

set -g @floax-bind '-n M-t'
set -g @floax-change-path 'false'

# TMUX plugin manager (keep at the bottom of tmux.conf)
run -b '~/.config/tmux/plugins/tpm/tpm'
